#!/usr/bin/env bash

# \brief Ensures dependencies are present
# \param $@ The dependencies to check for
function mvregex_check_dependencies
{
	for TOOL in "$@"; do
		if ! type "$TOOL" >/dev/null 2>/dev/null; then
			echo "$CODENAME: \"$TOOL\" is required for this application to work correctly." >&2
			exit
		fi
	done
}

function mvregex_help
{
	#     01234567890123456789012345678901234567890123456789012345678901234567890123456789
	echo "Description:"
	echo "  Move or rename files that match the given regular expression."
	echo
	echo "Usage:"
	echo "  $CODENAME [options] SOURCE_REGEX DESTINATION_REGEX FILE..."
	echo
	echo "Options:"
	echo "  -f, --force"
	echo "    Do not prompt before overwriting files. Disabled by default, but writable"
	echo "    files are still overwritten by default."
	echo "    Without this option, mvregex will overwrite files that are writable, and"
	echo "    only prompt for files that are not writable."
	echo "    With this option, mvregex will overwrite all files without prompting."
	echo "    If you specify more than one of -f, -i, -n, only the final one takes effect."
	echo "    See -i or -n to disable overwriting existing files."
	echo "  -h, --help"
	echo "    Display this help message and exit."
	echo "  -i, --interactive"
	echo "    Prompt before overwriting files. Disabled by default."
	echo "    If you specify more than one of -f, -i, -n, only the final one takes effect."
	echo "  -n, --no-clobber"
	echo "    Do not overwrite files. Disabled by default."
	echo "    If you specify more than one of -f, -i, -n, only the final one takes effect."
	echo "  -p, --pretend"
	echo "    Performs a dry run and prints out what files would be moved. No files are"
	echo "    actually moved. This option will increase the verbosity level from 0 to 1."
	echo "  -v"
	echo "    Show only the files that are moved. The same as --verbose 1."
	echo "  --verbose #"
	echo "    Use more or less verbose output. Valid values are:"
	echo "      0  Default. No output."
	echo "      1  Show only the files that are moved."
	echo "      2  Show all files that are processed."
	echo
	echo "Examples:"
	echo "  Convert \"JPG\" extension to \"jpg\""
	echo "    $CODENAME -p -v '[jJ][pP][eE]?[gG]\$' 'jpg' *"
	echo "  Convert \"###\" to \"S#E##\""
	echo "    $CODENAME -p -v '^([0-9])([0-9][0-9])' 'S\1E\2' *.mkv"
	echo "  Convert upper case to lower case"
	echo "    $CODENAME -p -v '(.*)' '\L\1' *"
	echo "  Convert lower case to upper case"
	echo "    $CODENAME -p -v '(.*)' '\U\1' *"
	echo
	echo "Version:"
	echo "  $NAME $VERSION"
	echo "  $COPYRIGHT"
	echo "  Licensed under $LICENSE"
}

#------------------------------------------------------------------------------
# hard coded variables

NAME="mvregex"
CODENAME="mvregex"
COPYRIGHT="Copyright (C) 2007 Nathan Shearer"
LICENSE="GNU General Public License 2.0"
VERSION="1.0.2.0"

#------------------------------------------------------------------------------
# default configuration

MV_ARGS=""
PRETEND=false
VERBOSE=0

#------------------------------------------------------------------------------
# config files

if [ -r /etc/$CODENAME.conf ]; then
	. /etc/$CODENAME.conf
fi
if [ -r ~/.$CODENAME.conf ]; then
	. ~/.$CODENAME.conf
fi

#------------------------------------------------------------------------------
# command line arguments

if [ $# -eq 0 ]; then
	mvregex_help
	exit 1
fi

THIS="$0"
while [ $# -ne 0 ]; do
	case "$1" in
		"-f"|"--force")
			MV_ARGS="$MV_ARGS -f"
			shift
			;;
		"-h"|"--help")
			mvregex_help
			exit
			;;
		"-i"|"--interactive")
			MV_ARGS="$MV_ARGS -i"
			shift
			;;
		"-n"|"--no-clobber")
			MV_ARGS="$MV_ARGS -n"
			shift
			;;
		"-p"|"--pretend")
			PRETEND=true
			if [ "$VERBOSE" -eq 0 ]; then
				VERBOSE=1
			fi
			shift
			;;
		"-v")
			VERBOSE=1
			shift
			;;
		"--verbose")
			VERBOSE="$2"
			shift 2
			;;
		*)
			break;;
	esac
done

SOURCE_REGEX="$1"
shift
DESTINATION_REGEX="$1"
shift

#------------------------------------------------------------------------------
# prepare environment

mvregex_check_dependencies sed mv

#------------------------------------------------------------------------------
# begin execution

for SOURCE in "$@"; do
	DESTINATION=`echo -n "$SOURCE" | sed -r "s/$SOURCE_REGEX/$DESTINATION_REGEX/"`
	if [ \( $VERBOSE -ge 1 \) -a \( "$SOURCE" != "$DESTINATION" \) ]; then
		echo "‘$SOURCE’ -> ‘$DESTINATION’"
	fi
	if [ \( $VERBOSE -ge 2 \) -a \( "$SOURCE" = "$DESTINATION" \) ]; then
		echo "‘$SOURCE’ -> ‘$DESTINATION’"
	fi
	if ! $PRETEND && [ "$SOURCE" != "$DESTINATION" ]; then
		mv $MV_ARGS "$SOURCE" "$DESTINATION"
	fi
done
